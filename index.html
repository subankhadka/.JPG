from flask import Flask, render_template, request, redirect, url_for, send_file, flash
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
import io
import csv
import datetime

app = Flask(__name__)
app.secret_key = 'secret'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///simple.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(150), unique=True)
    password_hash = db.Column(db.String(256))
    role = db.Column(db.String(10))

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

class Attendance(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    timestamp = db.Column(db.DateTime, default=datetime.datetime.utcnow)
    user = db.relationship('User', backref='attendance')

@app.before_first_request
def create_users():
    db.create_all()
    if not User.query.filter_by(username='ADMIN').first():
        admin = User(username='ADMIN', role='admin')
        admin.set_password('RABIN123')
        db.session.add(admin)
    if not User.query.filter_by(username='staff1').first():
        staff = User(username='staff1', role='staff')
        staff.set_password('nirakar@123')
        db.session.add(staff)
    db.session.commit()

@app.route('/', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        uname = request.form['username']
        pwd = request.form['password']
        user = User.query.filter_by(username=uname).first()
        if user and user.check_password(pwd):
            if user.role == 'admin':
                return redirect('/admin')
            else:
                return redirect('/staff/'+str(user.id))
        flash('Invalid login')
    return '''
        <h2>Login</h2>
        <form method="POST">
            <input name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
    '''

@app.route('/admin')
def admin():
    users = User.query.all()
    attendance = Attendance.query.order_by(Attendance.timestamp.desc()).all()
    report_link = '<a href="/download">Download CSV Report</a>'
    users_list = '<br>'.join([f'{u.username} ({u.role})' for u in users])
    attendance_list = '<br>'.join([f'{a.user.username} - {a.timestamp}' for a in attendance])
    return f"<h2>Admin Panel</h2>{report_link}<h3>Users</h3>{users_list}<h3>Attendance</h3>{attendance_list}"

@app.route('/download')
def download():
    attendance = Attendance.query.join(User).add_columns(User.username, Attendance.timestamp).all()
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(['Username', 'Timestamp'])
    for rec in attendance:
        writer.writerow([rec.username, rec.timestamp])
    output.seek(0)
    return send_file(io.BytesIO(output.getvalue().encode()), mimetype='text/csv', download_name='attendance.csv', as_attachment=True)

@app.route('/staff/<int:user_id>', methods=['GET', 'POST'])
def staff(user_id):
    user = User.query.get_or_404(user_id)
    if request.method == 'POST':
        att = Attendance(user_id=user.id)
        db.session.add(att)
        db.session.commit()
        return "<p>Attendance marked!</p><a href='/'>Logout</a>"
    return f'''
        <h2>Welcome {user.username}</h2>
        <form method="POST">
            <button type="submit">Mark Attendance</button>
        </form>
    '''

if __name__ == '__main__':
    app.run(debug=True)
